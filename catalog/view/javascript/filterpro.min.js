var fIID = 0;
var interval = 1;
$( document ).on( "change", ".price_limit", function() {
//     var b = parseInt($("#min_price").val());
//     var a = parseInt($("#max_price").val());
//     $("#slider-range").slider("values", [b, a]);
    iF()
});
$( document ).on( "change", "#filterpro .filtered", function() {
    iF()
});
$( document ).on( "keyup", "#filterpro .filtered_input", function() {
    iF()
});

$(function () {
    $("#slider-range").slider({range:true, min:0, max:0, values:[0, 0], stop:function (a, b) {
        iF()
    }, slide:function (a, b) {
        $("#min_price").val(b.values[0]);
        $("#max_price").val(b.values[1])
    }});
    $("#min_price").val($("#slider-range").slider("values", 0));
    $("#max_price").val($("#slider-range").slider("values", 1))
});
function iF() {
    clearTimeout(fIID);
    $("#filterpro_page").val(0);
    fIID = setTimeout("doFilter(false)", interval)
}
function doFilter(b) {
    var a = $("#filterpro").serialize().replace(/[^&]+=\.?(?:&|$)/g, "").replace(/&+$/, "");
    if (!b) {
        window.location.hash = a
    }
    $.ajax({url:"index.php?route=module/filterpro/getproducts", type:"POST", data:a + (b ? "&getPriceLimits=true" : ""), dataType:"json", success:function (g) {
        if (g.result) {
            $("#productList").html(g.result);
        }
        if (localStorage.getItem('display') == 'list') {
            $('#list-view').trigger('click');
        } else {
            $('#grid-view').trigger('click');
        }

        $(".pagination").html(g.pagination);
        var d = parseInt(g.min_price);
        var c = Math.ceil(parseFloat(g.max_price));

        if (typeof(display) != "undefined") {
            view ? display(view) : display("list");
        }
        if (b) {
            $("#slider-range").slider("option", {min:d, max:c});
            if ($("#max_price").val() >= 1) {
                d = parseInt($("#min_price").val());
                c = parseInt($("#max_price").val())
            }
            $("#slider-range").slider("option", {values:[d, c]});
            $("#min_price").val(d);
            $("#max_price").val(c);
			setGrid($("#slider-range"),{min:d, max:c});
        }
        if (g.totals_data) {
            var atts = {};
            $.each(g.totals_data.attributes, function(k, v) {
                atts[v.id + "_" + v.text] = v.t;
            });

            $('.a_name').each(function (k, v) {
                var at_v_i = $(v).attr('at_v_i');
                if (atts[at_v_i]) {
                     $('[at_v_t="'+at_v_i+'"]').text($('[at_v_t="'+at_v_i+'"]').attr('data-value')+"("+atts[at_v_i]+")");
                     $(v).removeAttr("disabled");
                } else {
                    $('[at_v_t="' + at_v_i + '"]').text($('[at_v_t="' + at_v_i + '"]').attr('data-value'));
                    $(v).attr("disabled", "disabled");
                    $(v).removeAttr('checked');
                    $(v).removeAttr(':selected');
                }
            });

            var h = [];
            $.each(g.totals_data.manufacturers, function (f, k) {
                if (k.id) {
                    h[h.length] = k.id;
                    var j = $("#manufacturer_" + k.id);
                    j.removeAttr("disabled");
                    if (j.get(0).tagName == "OPTION") {
                        j.text($("#m_" + k.id).val() + " (" + k.t + ")")
                    } else {
                        $('label[for="manufacturer_' + k.id + '"]').text($("#m_" + k.id).val() + " (" + k.t + ")")
                    }
                }
            });
            $(".manufacturer_value").each(function (f, k) {
                var j = $(this);
                var l = j.attr("id").match(/manufacturer_(\d+)/);
                if ($.inArray(l[1], h) < 0) {
                    j.attr("disabled", "disabled");
                    if (this.tagName == "OPTION") {
                        j.text($("#m_" + l[1]).val());
                        j.attr("selected", false)
                    } else {
                        $('label[for="manufacturer_' + l[1] + '"]').text($("#m_" + l[1]).val());
                        j.attr("checked", false)
                    }
                }
            });
            var e = [];
            $.each(g.totals_data.options, function (j, k) {
                if (k.id) {
                    e[e.length] = k.id;
                    var f = $("#option_value_" + k.id);
                    if (f.length) {
                        f.removeAttr("disabled");
                        if (f.get(0).tagName == "OPTION") {
                            f.text($("#o_" + k.id).val() + " (" + k.t + ")")
                        } else {
                            $('label[for="option_value_' + k.id + '"]').text($("#o_" + k.id).val() + " (" + k.t + ")")
                        }
                    }
                }
            });
            $(".option_value").each(function (j, k) {
                var f = $(this);
                var l = f.attr("id").match(/option_value_(\d+)/);
                if ($.inArray(l[1], e) < 0) {
                    f.attr("disabled", "disabled");
                    if (this.tagName == "OPTION") {
                        f.text($("#o_" + l[1]).val());
                        f.attr("selected", false)
                    } else {
                        $('label[for="option_value_' + l[1] + '"]').text($("#o_" + l[1]).val());
                        f.attr("checked", false)
                    }
                }
            })
        }
    }})
}
$(document).ready(function () {
    $(".option_box .option_name").click(function () {
        $(this).siblings(".collapsible").toggle();
        $(this).toggleClass("hided")
    });
    $(".option_box .attribute_group_name").click(function () {
        $(this).siblings(".attribute_box").toggle();
        $(this).toggleClass("hided")
    });
    $(".clear_filter").click(function () {
        $("#filterpro select").val("");
        $("#filterpro :input").each(function () {
            if ($(this).is(":checked")) {
                $(this).attr("checked", false)
            }
        });
        var b = $("#slider-range").slider("option", "min");
        var a = $("#slider-range").slider("option", "max");
        $("#slider-range").slider("option", {values:[b, a]});
        $("#min_price").val(b);
        $("#max_price").val(a);
        iF()
    });
    $( document ).on( "click", ".pagination .links a", function() {
        var a = $(this).attr("href");
        var b = a.match(/page=(\d+)/);
        $("#filterpro_page").val(b[1]);
        doFilter(false);
        return false
    });

    if($(".sort select").length){
        $(".sort select").get(0).onchange = null;
        $(".sort select").change(function () {
            vars = $(this).val().split("&");
            $("#filterpro_sort").val(vars[0]);
            $("#filterpro_order").val(vars[1]);
            iF()
        });
        $(".sort select option").each(function () {
            var d = $(this).val();
            var a = gUV(d, "sort");
            if (a == "rating") {
                $(this).remove()
            } else {
                $(this).val(a + "&" + gUV(d, "order"))
            }
        });
    }

    if ($(".limit select").length) {
        $(".limit select").get(0).onchange = null;
        $(".limit select").change(function () {
            $("#filterpro_limit").val($(this).val());
            iF()
        });
        $(".limit select option").each(function () {
            $(this).val(gUV($(this).val(), "limit"))
        });
    }

    $("#filterpro").deserialize(window.location.hash.substr(1));
    if ($(".sort select").length) {
        if ($("#filterpro_sort").val()) {
            $(".sort select").val($("#filterpro_sort").val() + "&" + $("#filterpro_order").val())
        } else {
            vars = $(".sort select").val().split("&");
            $("#filterpro_sort").val(vars[0]);
            $("#filterpro_order").val(vars[1])
        }
    }
    if ($("#filterpro_limit").length) {
        if ($("#filterpro_limit").val()) {
            $(".limit select").val($("#filterpro_limit").val())
        } else {
            $("#filterpro_limit").val($(".limit select").val())
        }
    }
    $("#filterpro input[type='checkbox'].showSlider").each(function() {
		switchSlider( $(this) );
	});
    doFilter(true)
});
function gUV(e, f) {
    var c = String(e).split("?");
    var a = "";
    if (c[1]) {
        var b = c[1].split("&");
        for (var g = 0; g <= (b.length); g++) {
            if (b[g]) {
                var d = b[g].split("=");
                if (d[0] && d[0] == f) {
                    a = d[1]
                }
            }
        }
    }
    return a
}
function setGrid($filter,options) {

	var prettify = function (num) {
		var n = num.toString();
		if (settings.prettify) {
			n = n.replace(/(\d{1,3}(?=(?:\d\d\d)+(?!\d)))/g, "$1 ");
		}
		return n;
	};

	var settings = $.extend({
		min: null,
		max: null,
		from: null,
		to: null,
		type: "single",
		step: 1,
		prefix: "",
		postfix: "",
		maxPostfix: "",
		hasGrid: false,
		gridMargin: 0,
		hideMinMax: false,
		hideFromTo: false,
		prettify: true,
		disable: false,
		values: null,
		onLoad: null,
		onChange: null,
		onFinish: null
	}, options);

	var gridBlock = document.createElement('div');
	$(gridBlock).addClass("irs-grid");
	$filter.addClass("irs-with-grid");

	var i,
		text = '',
		step = 0,
		tStep = 0,
		stepFloat = 0,
		gridHTML = '',
		smNum = 20,
		bigNum = 4,
		cont_width = $filter.width() - (settings.gridMargin * 2);



	for (i = 0; i <= smNum; i += 1) {
		step = Math.floor(cont_width / smNum * i);

		if (step >= cont_width) {
			step = cont_width - 1;
		}
		gridHTML += '<span class="irs-grid-pol small" style="left: ' + step + 'px;"></span>';
	}
	for (i = 0; i <= bigNum; i += 1) {
		step = Math.floor(cont_width / bigNum * i);

		if (step >= cont_width) {
			step = cont_width - 1;
		}
		gridHTML += '<span class="irs-grid-pol" style="left: ' + step + 'px;"></span>';

		if (stepFloat) {
			text = (settings.min + ((settings.max - settings.min) / bigNum * i));
			text = (text / settings.step) * settings.step;
			text = parseInt(text * stepFloat, 10) / stepFloat;
		} else {
			text = Math.round(settings.min + ((settings.max - settings.min) / bigNum * i));
			text = Math.round(text / settings.step) * settings.step;
			text = prettify(text);
		}

		if (i === 0) {
			tStep = step;
			gridHTML += '<span class="irs-grid-text" style="left: ' + tStep + 'px; text-align: left;">' + text + '</span>';
		} else if (i === bigNum) {
			tStep = step - 100;
			gridHTML += '<span class="irs-grid-text" style="left: ' + tStep + 'px; text-align: right;">' + text + '</span>';
		} else {
			tStep = step - 50;
			gridHTML += '<span class="irs-grid-text" style="left: ' + tStep + 'px;">' + text + '</span>';
		}
	}


	$(gridBlock).html(gridHTML);
	$filter.prepend(gridBlock);

};
function switchSlider($curr_item) {
	var attr_id = $curr_item.attr('rel');
    var b = parseInt($("#min_price-" + attr_id).val());
    var a = parseInt($("#max_price-" + attr_id).val());

    var d = parseInt($("#min_price-" + attr_id).attr("rel"));
    var c = parseInt($("#max_price-" + attr_id).attr("rel"));

    $("#slider-range-" + attr_id).slider({range:true, min:d, max:c, values:[b, a], stop:function (a, b) {
        iF()
    }, slide:function (a, b) {
        $("#min_price-" + attr_id).val(b.values[0]);
        $("#max_price-" + attr_id).val(b.values[1])
    }});
	setGrid($("#slider-range-" + attr_id),{min:d, max:c});

	if ($curr_item.is(':checked')) {
		$curr_item.closest("table").find('input[type="text"]').removeAttr("disabled");
		$("#slider-range-" + attr_id).slider( "enable" );
	} else {
		$curr_item.closest("table").find('input[type="text"]').attr("disabled","disabled");
		$("#slider-range-" + attr_id).slider( "disable" );
	}
}